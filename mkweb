#!/bin/sh
# mkweb v0.1; copyright 2021 Job79
# license: mit-license.org
HELP(){ printf "USAGE
	mkweb command [args...]

COMMANDS
	run [filter]		Generate changed files
	crun [filter]		Clean and generate files
	clean			Remove generated website files
"; }
RUN(){
	[ -x 'config' ] && . './config'
	find 'src' -name "${1:-*}" -type f | while read -r in
	do
		out="out/${in#*/}"
		if [ ! -z "$1" ] || [ ! -f "$out" ] || [ "$( find "$in" -newer "$out" )" ]; then
			log "$in" 'run'
			outdir="${out%/*}"; [ ! -d "$outdir" ] && mkdir -p "$outdir"
			if [ -x "$in" ]; then . "./$in" > "$out"; else cp "$in" "$out"; fi
			printf "$hooks" | sort -n | while read -r hook; do ${hook#*:}; done;
		fi
	done
	[ -x 'publish' ] && . './publish'
}
CLEAN(){ log 'cleaned output folder'; rm -rf out; }

cd "$(dirname "$(realpath "$0")")" || exit;
debug='0'; . './lib'
case "$1" in
	run) shift; RUN "$@" ;;
	crun) shift; CLEAN; RUN; "$@" ;;
	clean) shift; CLEAN "$@" ;;
	*) HELP ;;
esac
exit 0
